<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>

        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="keywords" content="application risk management map whatcom conservation district" />
        <meta name="description" content="application risk management map page" />
        <title>Runoff Risk Advisory Forecast</title>

<!-- CSS Framework -->
    <link href="/css/styles.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/css/blueprint_screen.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/css/blueprint_typo.css" media="screen" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="OpenLayers/theme/default/style.css" type="text/css" />
<!--[if lt IE 8]> <link href="/app/stylesheets/blueprint/ie.css?1329853689" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
        
<!-- Javascript Framework -->
    <script src="bc_tableConstructor.js"></script>
    <!--<link rel="stylesheet" href="http://openlayers.org/dev/examples/style.css" type="text/css" />-->
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script src="OpenLayers/OpenLayers.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var map;
      var popup;
      // Avoid pink error tiles
      OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
      OpenLayers.Util.onImageLoadErrorColor = "transparent";

      // parses our GetFeatureInfo for the precipgrp id
      function setHTML(response) {
	if (popup != null) {
		map.removePopup(popup);
		popup = null;
	}
	popupPixel = new OpenLayers.Pixel(50, 50);
	text = response.responseText;
	if (text.indexOf('no features were found') != -1) return;
	//console.log(text);	
	var precipgrpVal = undefined;
	
	var riskVal = undefined;
	var dateVal = undefined;
	var noaalinkVal = undefined;
	if( $(text).find('tr').length > 0 ) {
		// here we parse the last row of values from GetFeatureInfo request
		precipgrpVal = $( $(text).find('tr').last().find('td')[1] ).text();
		riskVal = $( $(text).find('tr').last().find('td')[3] ).text();
		dateVal = $( $(text).find('tr').last().find('td')[4] ).text();
		noaalinkVal = $( $(text).find('tr').last().find('td')[5] ).text();
	}
	/*
	popup = new OpenLayers.Popup("info", 
		map.getLonLatFromPixel(popupPixel), 
		new OpenLayers.Size(500, 500), precipgrp , 
		true);
	popup.panMapIfOutOfView = true;
	map.addPopup(popup);
	*/
	OpenLayers.loadURL("myapp", 
                { format : 'application/json', 
		precipgrp : (precipgrpVal == undefined) ? '': precipgrpVal,
		date : (dateVal == undefined) ? '': dateVal,
		risk : (riskVal == undefined) ? '': riskVal,
		noaalink : (noaalinkVal == undefined) ? '': noaalinkVal}, 
                map, setPopupHTML, setPopupHTML);
     }

     /** calls on JS in the bc_tableConstructor.js file to build popup table **
      ** then makes popup appear at popupPixel point **/
     function setPopupHTML(response) {
	if (popup != null) {
		map.removePopup(popup);
		popup = null;
	}
	popupPixel = new OpenLayers.Pixel(50, 50);
	text = response.responseText;
	if (text.indexOf('no features were found') != -1) return;
	var table = buildPopupTable(text); // call to tableConstructor here
	popup = new OpenLayers.Popup("info", 
		map.getLonLatFromPixel(popupPixel), 
		new OpenLayers.Size(350, 240), 
		table,
		true
		);
	popup.panMapIfOutOfView = true;
	map.addPopup(popup);
     }

     function testRequest(response) {
	text = response.responseText;
	//console.log(response);
	//console.log(text);
     }

      function init2(){
	  // Map is in mercator this time
	  // so over-ride the defaultoptions that assume lat/lon.
	  var options = {
	      projection: new OpenLayers.Projection("EPSG:900913"),
	      displayProjection: new OpenLayers.Projection("EPSG:4326"),
	      units: "m",
	      numZoomLevels: 20,
	      maxResolution: 156543.0339,
	      maxExtent: new OpenLayers.Bounds(-20037508, -20037508,
						      20037508, 20037508.34)
	  };

	  // Create the map object
	  map = new OpenLayers.Map('map', options);

	  // Layers
	  var gmap = new OpenLayers.Layer.Google(
	      "Google Streets", // the default
	      {'sphericalMercator': true, numZoomLevels: 20}
	  );
	  var gsat = new OpenLayers.Layer.Google(
              "Google Satellite",
              {type: google.maps.MapTypeId.SATELLITE, 
              'sphericalMercator': true, numZoomLevels: 20}
          );

	  var watershed = new OpenLayers.Layer.WMS(
		   "ARM Risk Rates",
		   "http://70.89.122.225:8080/geoserver/ARM/wms", 
		   {'layers': 'ARM:ARMRiskRateMap-PrecipGrp', 'format':'image/png', 'transparent':'true'},
		   {'opacity': 1.0, 'isBaseLayer': false, 'visibility': true}
		
	  );
	
	
	  map.addLayers([gmap, gsat, watershed]);
	  map.addControl(new OpenLayers.Control.LayerSwitcher());
	  // Coordinate display at bottom of map
	  map.addControl(new OpenLayers.Control.MousePosition());
	  var point = new OpenLayers.LonLat(-122.30782,48.86052); 
	  // Need to convert zoom point to mercator too
	  point.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
	   
		    
	  map.setCenter(point, 9); 

	  var roundVal = function (val){
		var dec = 3;
		var result = Math.round(val*Math.pow(10,dec))/Math.pow(10,dec);
		return result;
	  };

	  // Tie click event to WMS GetFeatureInfo call        
	  map.events.register('click', map, function (e) {
	    //this needed a reverse proxy pass
	    var url = "http://70.89.122.225/geoserver" 

	    var paramHash =  {
	      REQUEST : "GetFeatureInfo" ,
	      EXCEPTIONS : "application/vnd.ogc.se_xml" ,
	      SERVICE : "WMS" , 
	      VERSION : "1.1.1" ,
	      BBOX : map.getExtent().toBBOX() ,
	      X : Math.round(e.xy.x) ,
	      Y : Math.round(e.xy.y) ,
	      INFO_FORMAT : "text/html" , 
	      QUERY_LAYERS : "ARMRiskRateMap-PrecipGrp" , 
	      LAYERS : "ARMRiskRateMap-PrecipGrp" ,
	      FEATURE_COUNT : 50 , 
	      format : "image/png" ,
	      srs : "EPSG:900913" ,
	      styles : "" ,
	      WIDTH : map.size.w , 
	      HEIGHT : map.size.h
	    };
	   
	  	

	    //getFeatureInfo Request
	    OpenLayers.loadURL(url, paramHash, this, setHTML, setHTML);
	    //getDataRequest	
	    	/*
	    OpenLayers.loadURL("myapp", 
		{ format : 'application/json'}, 
		this, setPopupHTML, setPopupHTML);
 		*/
      	    OpenLayers.Event.stop(e);
	   });



      }
    </script>
<script type="text/javascript">
Cufon.replace("h1#title");
</script>
    
<head>
<body id="runoffRisk" onload="init2()">
<div id="wrapper">

  <div id="header" class="container">
    <h1 id="title" class="span-15 alt" style="font-size:x-large">Whatcom County Manure Spreading Advisory<br/>
    <span style="font-size:medium;color:#5d9ce3">Whatcom CD Application Risk Management System</span></h1>
    <div id="logo" class="span-2 prepend-1"><img src="http://www.whatcomcd.org/sites/default/files/images/WCDLogo.png" /></div>
    <div id="push"></div>
  </div>

  <div id="nav" class="center"> 
    <ul>

        <li class="floated"><a href="/app/" id="mas">MMAS Home</a></li>
        <li class="floated"><a href="/app/applicationmaps" id="appMaps">590 Nutrient Appl. Restriction Maps</a></li>
        <li class="floated"><a href="/app/runoffrisk" id="runoffRisk">Runoff Risk Advisory Forecast Map</a></li>
        <li class="floated"><a href="/app/interactive">Interactive/Online 590 Maps</a></li>
        <li class="floated"><a href="/app/web_svcs_data">DATCP Web Svcs</a></li>
        <li class="floated"><a href="/app/contacts" id="contacts">Contact Us</a></li>

    </ul>
</div>

    <div class="container">
    <div id="content" class="span-23 prepend-1">
        <div class="span-17">
            <div class="span-20" style="margin-bottom:-20px">
            <!--<table id="legend" style="margin-top:-6px;width:50%">-->
		<p>
                <img src="http://70.89.122.225/geoserver?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=ARM:ARMRiskRateMap-PrecipGrp">
		</p>
        </div>
        <div class="push"></div>
    <div id="map"></div>
    <div id="scale"></div>

        </div>
        <div id="sidebar" class="span-6 last">

  <h3>The Forecast</h3>
  <ul>
    <li>The Runoff Risk Advisory Forecast map shows day-to-day risk of runoff occurring across Wisconsin using National Weather Service forecast methods 
    that consider precipitation, soil moisture, and individual basin characteristics.</li>
  </ul>

    <ul>
      <li><a href="/app/runoff_using">Using this map</a></li>

        <li><a href="/app/runoff_about">About the forecast</a></li>
        <li><a href="/app/runoff_spread_with_high">Need to spread on a high-risk day?</a></li>
        <li><a href="/app/events/wx">More weather information</a></li>
    </ul>
        <h3>Additional Resources</h3>
    <ul>    
        <li><a href="/app/applicationmaps">Field maps for spreading</a></li>

        <li><a href="http://datcp.wi.gov/Farms/Nutrient_Management/Planning/index.aspx">NM planning & NCRS 590 standard</a></li>
        <li><a href="/app/events/cafo">Information for CAFOs</a>  </li>
        <li><a href="http://www.snapplus.net">WI-specific NM software</a></li>
        <li><a href="/app/events/soil_temps">Soil Temperatures</a></li>
        
    </ul>
    
    <h3>Help and Contacts</h3>

    <ul>
        <li><a href="/app/events/sys_req">System requirements</a></li>
        <li><a href="/app/contacts">Contact/Feedback</a></li>
        <li><a href="/app/events/credits">Credits</a></li>
        <!-- <li><a href="/app/runoffrisk">Troubleshooting FAQs</a></li> -->
    </ul>

</div>

    </div>
        
    </div> <!--end container -->
    <div id="push"></div>
</div> <!--end wrapper -->

            <div id="footer" class="group">
        <div class="blue">
            <h6>Department of Agriculture, Trade and Consumer Protection</h6>

            <h6>Wisconsin Manure Management Advisory System &copy 2011</h6>
        </div>
        <br />
        
        <ul>
            <li class="floated"><a href="http://www.datcp.state.wi.us"><img alt="Department of Agriculture, Trade and Consumer Protection" src="" title="Department of Agriculture, Trade and Consumer Protection" /></a></li>
            <li class="floated"><a href="http://www.weather.gov"><img alt="National Weather Service" src="" title="National Weather Service" /></a></li>
            <li class="floated"><a href="http://www.noaa.gov"><img alt="National Oceanic and Atmospheric Administration" src="" title="National Oceanic and Atmospheric Administration" /></a></li>

            <li class="floated"><a href="http://www.soils.wisc.edu"><img alt="University of Wisconsin-Madsion, Department of Soil Science" src="" title="University of Wisconsin-Madsion, Department of Soil Science" /></a></li>
            <li class="floated"><a href="http://www.soils.wisc.edu"><img alt="University of Wisconsin-Madsion, College of Agriculture and Life Sciences" src="" title="University of Wisconsin-Madsion, College of Agriculture and Life Sciences" /></a></li>
            <li class="floated"><a href="http://www.wi.nrcs.usda.gov"><img alt="Natural Resources Conservation Service" src="" title="Natural Resources Conservation Service" /></a></li>
            <li class="floated"><a href="http://www.uwplatt.edu/pioneerfarm"><img alt="University of Wisconsin-Platteville, Pioneer Farm" src="" title="University of Wisconsin-Platteville, Pioneer Farm" /></a></li>
            <li class="floated"><a href="http://www.uwdiscoveryfarms.org"><img alt="University of Wisconsin, Discovery Farms" src="" title="University of Wisconsin, Discovery Farms" /></a></li>
            <li class="floated"><a href="http://www.usgs.gov"><img alt="U.S. Geological Survey" src="" title="U.S. Geological Survey" /></a></li>
            <li class="floated"><a href="http://www.uwplatt.edu"><img alt="University of Wisconsin-Platteville" src="" title="University of Wisconsin-Platteville" /></a></li>
            <li class="floated"><a href="http://www.wisc.edu"><img alt="University of Wisconsin-Madsion" src="" title="University of Wisconsin-Madsion" /></a></li>   
        </ul>
    </div>
</body>
</html> 
